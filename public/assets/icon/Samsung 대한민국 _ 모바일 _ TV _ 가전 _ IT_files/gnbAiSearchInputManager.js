let gnbConstMap={POPULAR__SEARCH__TITLE:"인기 검색어",SUGGESTED__SEARCH__TITLE:"이걸 찾고 계시나요?",RECOMM__PRODUCT__TITLE:"추천",RELATED__PRODUCT__TITLE:"관련된 제품"};
const searchHistoryManager=(()=>{let cookieName;function getSearchHistory(){return $.cookie(cookieName)}function searchHistoryTemplate(keyword){return{keyword:keyword,date:searchDatetimestampToString(new Date)}}function getSearchDate(keyword){const searchHistoryList=getSearchHistory();if(!searchHistoryList||!Array.isArray(searchHistoryList.data))return"";const dataList=searchHistoryList.data;const item=dataList.find(entry=>{return entry.keyword&&entry.keyword.toLocaleLowerCase()===keyword.toLocaleLowerCase()});
return item?item.date:""}function getKeywordList(cookieName){const searchKeywordList=[];let dataList;if($.cookie(cookieName))dataList=$.cookie(cookieName).data;if(!dataList)return searchKeywordList;dataList.forEach(element=>{searchKeywordList.push(element.keyword)});return searchKeywordList}function saveSearchHistory(keyword){const cookieValue=$.cookie(cookieName);let dataList=[];if(cookieValue===undefined)dataList=[searchHistoryTemplate(keyword)];else if(cookieValue.length===0)dataList=[searchHistoryTemplate(keyword)];
else{dataList=cookieValue.data;if(getKeywordList(cookieName).indexOf(keyword)>=0)return;if(dataList.length>=$.cookie.data.SEARCH_MAX_SIZE)dataList.splice(0,1);dataList.push(searchHistoryTemplate(keyword))}$.cookie(cookieName,{"data":dataList},$.cookie.data.option)}function getSearchHistoryKeywordList(){return getKeywordList(cookieName)}return{init:()=>{$.cookie.json=true;$.cookie.data={SEARCH_HISTORY:`sh-${gnbConstMap.stGrp}`,SEARCH_MAX_SIZE:4,option:{expires:1,path:"/"}};cookieName=$.cookie.data.SEARCH_HISTORY},
saveSearchHistory,getSearchHistoryKeywordList}})();
const gnbSearchRequestInfoManager=(()=>{let searchUrl;let requestInfoMap;let appType;function getUUIDInfo(){const uuid=()=>{const crypto=window.crypto||window.msCrypto;const uuidTemplate="10000000-1000-4000-8000-100000000000";return uuidTemplate.replace(/[018]/g,char=>{const randomValue=crypto.getRandomValues(new Uint8Array(1))[0];return char^(randomValue&15>>char/4).toString(16)})};return{ui:uuid(),ti:uuid(),qi:uuid(),si:uuid()}}function getAppType(){const isIos=device.agent.match(/ipad|iphone/i);
const isAos=device.agent.match(/android/i);const isSecIos=device.agent.match(/secios/i);const isSecApp=device.agent.match(/secapp|sectest/i);let appType="window";if(isIos)appType=isSecIos?"secIos":"ios";if(isAos)appType=isSecApp?"secApp":"android";return appType}function getStaticMetricsParamInfo(){return{...getUUIDInfo(),cn:"scom",ch:"1",cc:"sec",lc:"kr",ff:appType}}function getStaticFeedbackParamInfo(){return{...getUUIDInfo(),st:"1",ct:"sec",cn:"scom"}}function getRequestInfo(key){return requestInfoMap[key]}
return{init:()=>{appType=getAppType();searchUrl=`${gnbConstMap.aiSearchUrl}/estoresearch-api/v1/scom/sec`;requestInfoMap={aiSearchPopularKeyword:{url:`${searchUrl}/popularSearch`,type:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{baseURL:"",clientCode:gnbConstMap.stGrp,countryCode:"sec",storeID:"1"},cache:"default"},aiSearchRecomGoods:{url:`${gnbConstMap.stContextPath}xhr/search/getBdcRecommendGoods`,dataType:"json",type:"POST",data:{reqUrl:location.href},contentType:"application/x-www-form-urlencoded",
processData:true},recommendKeyword:{url:`${gnbConstMap.stContextPath}xhr/search/recommendkeyword/`,type:"GET"},suggestedSearch:function(keyword,isTyping){return{url:`${searchUrl}/suggestedSearch`,type:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{query:keyword,clientCode:gnbConstMap.stGrp,countryCode:"sec",storeID:"1",isTyping:isTyping}}},aiSearchMetrics:function(metricsType,keyword,searchCount){let data=getStaticMetricsParamInfo();return{url:`${searchUrl}/metrics/${metricsType}`,
headers:{"Content-Type":"application/x-www-form-urlencoded"},type:"POST",feature:"metrics",data:{...data,qt:keyword,sc:searchCount}}},aiSearchFeedback(keyword,feedbackType,searchCount,rank,feedbackParam){let data=getStaticFeedbackParamInfo();return{url:`${searchUrl}/feedback/click`,headers:{"Content-Type":"application/x-www-form-urlencoded"},type:"POST",feature:"feedback",data:{...data,qt:encodeURIComponent(keyword),ft:feedbackType,tr:searchCount,dr:rank},feedbackParam:feedbackParam}},aisearch:function(keyword){return{url:`${gnbConstMap.stContextPath}aisearch/?searchvalue=${encodeURIComponent(keyword)}`,
type:"POST",headers:{"Content-Type":"application/json"}}}}},getRequestInfo}})();
const gnbSearchInputElementDrawer=(()=>{const elemMap={};const CONTENT__VIEW__LEFT="content__view__left";const CONTENT__VIEW__RIGHT="content__view__right";function formatPrice(rawData){if(typeof rawData==="string")rawData=rawData.replace(/,/g,"");const num=Number(rawData);if(isNaN(num))return" ";return Math.floor(num).toLocaleString()}function getElement(key){return elemMap[key]}function setLeftArea(appendingTarget,info,callback){const viewTitle=appendingTarget.querySelector(".view__tit");viewTitle.textContent=
info.viewTitle;const viewText=appendingTarget.querySelector(".view__txt");viewText.innerHTML="";viewText.setAttribute("sc",info.searchCount);const infoList=info.infoList;if(!Array.isArray(infoList)||infoList.length===0)return;infoList.forEach(elem=>{const li=document.createElement("li");const a=document.createElement("a");if(info.viewTitle===gnbConstMap.SUGGESTED__SEARCH__TITLE)a.setAttribute("data-omni",elem.selectedKeyword+":"+elem.category+":"+info.keyword);a.href="javascript:void(0)";a.innerHTML=
elem.name;li.appendChild(a);viewText.appendChild(li)});callback(appendingTarget,info)}function clearRightArea(){elemMap["basic__view__right"].innerHTML=""}function setRightArea(appendingTarget,info,callback){const viewTitle=appendingTarget.querySelector(".view__tit");viewTitle.textContent=info.title;const viewThumbnail=appendingTarget.querySelector(".view__thumbnail");viewThumbnail.innerHTML="";if(info.goodsInfo===null)return;const elementInfo=info.goodsInfo.elementInfo;elementInfo.forEach(element=>
{const productInfoLI=document.createElement("li");const productInfoA=document.createElement("a");const productInfoImgDIV=document.createElement("div");const productInfoImg=document.createElement("img");const productInfoName=document.createElement("p");productInfoLI.appendChild(productInfoA);productInfoA.appendChild(productInfoImgDIV);productInfoImgDIV.appendChild(productInfoImg);productInfoA.appendChild(productInfoName);productInfoA.href="javascript:void(0)";if(info.title===gnbConstMap.RECOMM__PRODUCT__TITLE)productInfoA.setAttribute("data-omni",
element.name+":"+element.modelCode);if(info.title===gnbConstMap.RELATED__PRODUCT__TITLE){productInfoA.setAttribute("data-feedback",element.feedbackParam);productInfoA.setAttribute("data-omni",info.keyword+":"+element.name+":"+element.modelCode)}productInfoImgDIV.classList.add("img-box");productInfoImg.src=element.imgUrl;productInfoImg.alt=element.name;productInfoName.textContent=element.name;if(element.priceInfo.price!==""||element.priceInfo.priceTitle!==""){const productPriceTitle=document.createElement("span");
productPriceTitle.textContent=element.priceInfo.priceTitle;const productPrice=document.createElement("strong");productPrice.textContent=formatPrice(element.priceInfo.price)+"원";productInfoA.appendChild(productPriceTitle);productInfoA.appendChild(productPrice)}viewThumbnail.appendChild(productInfoLI)});callback(appendingTarget,info)}return{init:()=>{elemMap["basic__view__left"]=document.querySelector(".content__basic .content__view__left");elemMap["basic__view__right"]=document.querySelector(".content__basic .content__view__right");
elemMap["result__view__left"]=document.querySelector(".content__result .content__view__left");elemMap["result__view__right"]=document.querySelector(".content__result .content__view__right")},getElement,setLeftArea,clearRightArea,setRightArea}})();
const gnbSearchInputRequestManager=(()=>{let path=location.pathname;let baseUrl;let timeOut=1E4;function createHeaders(options){const header=new Headers(options.headers||{});if(!header.has("Content-Type"))header.set("Content-Type","application/json");return header}function handleBody(options,headers){if(options.type.toUpperCase()==="GET"||!options.data)return null;let body;const contentType=headers.get("Content-Type");if(contentType.startsWith("application/x-www-form-urlencoded")){const params=new URLSearchParams;
Object.keys(options.data).forEach(key=>{params.append(key,options.data[key])});body=params}else body=JSON.stringify(options.body);if(options.feature)if(options.feature==="metrics")body=(new URLSearchParams({metricsParam:body.toString()})).toString();else if(options.feature==="feedback")body=(new URLSearchParams({feedbackParam:options.feedbackParam||body.toString(),actionType:"click"})).toString();return body}async function fetchRequest(options){try{const headers=createHeaders(options);let body=handleBody(options,
headers);const controller=new AbortController;const signal=controller.signal;const fetchOptions={method:options.type,headers,body};const response=await fetch(options.url,fetchOptions);if(!response.ok)throw new Error(`Http error! status: ${response.status}`);clearTimeout(()=>controller.abort(),timeOut);const data=await response.json();if(data?.exCode&&typeof data.abc==="string"&&data.abc!==""){if(typeof options.fail==="function")options.fail();const alertData={title:"alert",content:data.exMsg};commonAlert(alertData);
openLayer("commonAlert");return{isError:true,errorType:"ExCodeError",data}}return{isError:false,data:data}}catch(error){return{isError:true,errorType:error.name==="AbortError"?"TimeoutError":"NetworkError",error:error}}}return{init:()=>{baseUrl="/"+path.replace(gnbConstMap.stContextPath,"")},fetchRequest}})();
const gnbSearchInputLogicManager=(()=>{const LEFT__MAX__LEN=4;const RIGHT__MAX__LEN=4;const CONTENT__VIEW__LEFT="content__view__left";const CONTENT__VIEW__RIGHT="content__view__right";let searchAreaInner;let contentBasicArea;let contentResultArea;let drawInfoTmp={goodsInfo:{},searchCount:0};let listInfoTmp={viewTitle:"인기 검색어",infoList:[],searchCount:0};let searchInput;let searchButton;let recommendKeyword;let typingTimer;let debounceDelay=600;function highlightword(text,word){const escapeRexExp=string=>
string.replace(/[.*+?^$()|[\]\\{}]/g,"\\$&");const escapeWord=escapeRexExp(word);const regex=new RegExp("("+escapeWord+")","gmiu");return text.replace(regex,"<strong>$1</strong>")}function fetchSearchHistoryInfo(){let infoList=searchHistoryManager.getSearchHistoryKeywordList();if(Array.isArray(infoList)){infoList=infoList.slice(0,Math.min(infoList.length,LEFT__MAX__LEN));infoList=infoList.map(elem=>{return{name:elem}})}return{viewTitle:"최근 검색어",infoList:infoList}}function fetchSuggestedSearchInfo(suggestedSearches,
keyword){const viewTitle="이걸 찾고 계시나요?";let infoList=suggestedSearches.results.slice(0,Math.min(suggestedSearches.count,LEFT__MAX__LEN));infoList=infoList.map(elem=>{return{category:elem.category,selectedKeyword:elem.name,name:highlightword(elem.name,keyword)}});return{searchCount:suggestedSearches.count,viewTitle,infoList,keyword}}function fetchRelatedGoodsInfo(relatedProducts,keyword){const drawInfo={requestId:"",elementInfo:relatedProducts.results.map(element=>{return{imgUrl:element.images.laImage,
name:element.name,pdpURL:element.pdpURL,modelCode:element.sku,feedbackParam:element.feedbackParam,priceInfo:{price:element.salePrice,priceTitle:element.discount===0?"기준가":"혜택가"}}})};drawInfo.elementInfo=drawInfo.elementInfo.slice(0,Math.min(drawInfo.elementInfo.length,RIGHT__MAX__LEN));return{title:"관련된 제품",keyword:keyword,searchCount:relatedProducts.count,goodsInfo:drawInfo}}function setLeftAreaEvent(target,data){const viewTitle=target.querySelector("."+CONTENT__VIEW__LEFT+"> strong");const liList=
target.querySelectorAll("."+CONTENT__VIEW__LEFT+"> ul > li");liList.forEach((li,idx)=>{const a=li.querySelector("a");a.addEventListener("click",function(){window.location.href="/sec/aisearch/?searchvalue="+a.textContent;if(viewTitle.textContent===gnbConstMap.SUGGESTED__SEARCH__TITLE)feedBack(gnbSearchRequestInfoManager.getRequestInfo("aiSearchFeedback")(a.getAttribute("data-omni"),"SS",data.searchCount,idx,null))})})}function setRightAreaEvent(target,data){const viewTitle=target.querySelector("."+
CONTENT__VIEW__RIGHT+"> strong");const liList=target.querySelectorAll("."+CONTENT__VIEW__RIGHT+"> ul > li");liList.forEach((li,index)=>{const a=li.querySelector("a");let pdpUrl=data.goodsInfo.elementInfo[index].pdpURL;pdpUrl=pdpUrl.startsWith("/sec/")?pdpUrl:"/sec/"+pdpUrl;a.addEventListener("click",function(){if(viewTitle.textContent===gnbConstMap.RELATED__PRODUCT__TITLE){const keyword=a.getAttribute("data-omni").split(":")[0];feedBack(gnbSearchRequestInfoManager.getRequestInfo("aiSearchFeedback")(keyword,
"SS",data.searchCount,index,a.getAttribute("data-feedback")))}NetFunnel_Action_pdView(pdpUrl);return false})})}function feedBack(options){gnbSearchInputRequestManager.fetchRequest(options).then(response=>{}).catch(()=>{})}async function fetchPopularSearchInfo(){const response=await gnbSearchInputRequestManager.fetchRequest(gnbSearchRequestInfoManager.getRequestInfo("aiSearchPopularKeyword"));let infoList;if(response.isError||!response.data.popularSearchResults||!response.data.popularSearchResults.resultSet)infoList=
[];else{infoList=response.data.popularSearchResults.resultSet;infoList=infoList.map(elem=>{return{name:elem}});infoList.searchCount=infoList.length;infoList=infoList.slice(0,Math.min(infoList.length,LEFT__MAX__LEN));listInfoTmp.infoList=infoList}return{searchCount:infoList.length,viewTitle:"인기 검색어",infoList:infoList}}async function fetchRecommGoodsInfo(){const response=await gnbSearchInputRequestManager.fetchRequest(gnbSearchRequestInfoManager.getRequestInfo("aiSearchRecomGoods"));let goodsImg,goodsInfo,
pricePointInfo;if(response.isError||response.errorType==="TimeoutError"){goodsImg=[];goodsInfo=[];pricePointInfo=[]}goodsImg=response.data.recomGoodsImg||[];goodsInfo=response.data.recomGoodsList||[];pricePointInfo=response.data.pfPricePointExcptYn||[];const drawInfo={requestId:response.data.requestId,elementInfo:goodsInfo.map((elem,index)=>{const useSalePrice=pricePointInfo[index]==="Y";const candidatePrice=useSalePrice?goodsInfo[index].salePrc:goodsInfo[index].price;const candidateTitle=useSalePrice?
"기준가":"혜택가";let price,priceTitle;if(candidatePrice==0||candidatePrice==null){price="";priceTitle=""}else{price=candidatePrice.toLocaleString("ko-KR");priceTitle=candidateTitle}return{imgUrl:goodsImg[index],name:goodsInfo[index].goodsNm,modelCode:goodsInfo[index].mdlCode,pdpURL:goodsInfo[index].goodsUrl,priceInfo:{price:price,priceTitle:priceTitle}}})};let searchCount=drawInfo.elementInfo.length;drawInfo.elementInfo=drawInfo.elementInfo.slice(0,Math.min(drawInfo.elementInfo.length,RIGHT__MAX__LEN));
if(drawInfo.elementInfo.length>0){drawInfoTmp.goodsInfo=drawInfo;drawInfoTmp.searchCount=searchCount}return{title:"추천",searchCount,goodsInfo:drawInfo}}async function renderOnKeyUp(keyword,isTyping){const response=await gnbSearchInputRequestManager.fetchRequest(gnbSearchRequestInfoManager.getRequestInfo("suggestedSearch")(keyword,isTyping));if(response.isError||!response.data||response.data.statusCode!==200)return;const relatedProducts=response.data.resultData.relatedProducts;const suggestedSearches=
response.data.resultData.suggestedSearches;if(suggestedSearches.count===0){searchAreaInner.classList.remove("result");searchAreaInner.classList.add("none");gnbSearchInputElementDrawer.setLeftArea(gnbSearchInputElementDrawer.getElement("result__view__left"),listInfoTmp.infoList.length===0?fetchPopularSearchInfo():{viewTitle:"인기 검색어",infoList:listInfoTmp.infoList,searchCount:listInfoTmp.searchCount},setLeftAreaEvent)}else{searchAreaInner.classList.remove("none");searchAreaInner.classList.add("result");
gnbSearchInputElementDrawer.setLeftArea(gnbSearchInputElementDrawer.getElement("result__view__left"),fetchSuggestedSearchInfo(suggestedSearches,keyword),setLeftAreaEvent);if(isTyping==="N")if(relatedProducts.count===0)if(gnbConstMap.recomGoodsHideYn==="Y")gnbSearchInputElementDrawer.clearRightArea();else gnbSearchInputElementDrawer.setRightArea(gnbSearchInputElementDrawer.getElement("result__view__right"),{title:"추천",goodsInfo:drawInfoTmp.goodsInfo,searchCount:drawInfoTmp.searchCount},setRightAreaEvent);
else gnbSearchInputElementDrawer.setRightArea(gnbSearchInputElementDrawer.getElement("result__view__right"),fetchRelatedGoodsInfo(relatedProducts,keyword),setRightAreaEvent)}feedBack(gnbSearchRequestInfoManager.getRequestInfo("aiSearchMetrics")("suggestedSearch",keyword,suggestedSearches.count))}async function inputEventLogic(event){const text=event.target.value;if(text.length===0){clearTimeout(typingTimer);gnbSearchInputElementDrawer.setLeftArea(gnbSearchInputElementDrawer.getElement("basic__view__left"),
searchHistoryManager.getSearchHistoryKeywordList().length===0?{viewTitle:"인기 검색어",infoList:listInfoTmp.infoList,searchCount:listInfoTmp.searchCount}:fetchSearchHistoryInfo(),setLeftAreaEvent);if(gnbConstMap.recomGoodsHideYn==="Y")gnbSearchInputElementDrawer.clearRightArea();else{let info;if(Object.keys(drawInfoTmp.goodsInfo).length>0)info={title:"추천",searchCount:drawInfoTmp.searchCount,goodsInfo:drawInfoTmp.goodsInfo};else info=await fetchRecommGoodsInfo();gnbSearchInputElementDrawer.setRightArea(gnbSearchInputElementDrawer.getElement("basic__view__right"),
info,setRightAreaEvent)}}else{await renderOnKeyUp(text,"Y");clearTimeout(typingTimer);typingTimer=setTimeout(()=>{renderOnKeyUp(text,"N")},debounceDelay)}}async function openGnbSearchInputArea(){try{gnbSearchInputElementDrawer.setLeftArea(gnbSearchInputElementDrawer.getElement("basic__view__left"),searchHistoryManager.getSearchHistoryKeywordList().length===0?await fetchPopularSearchInfo():fetchSearchHistoryInfo(),setLeftAreaEvent);if(gnbConstMap.recomGoodsHideYn==="Y")gnbSearchInputElementDrawer.clearRightArea();
else{let info;if(Object.keys(drawInfoTmp.goodsInfo).length>0)info={title:"추천",searchCount:drawInfoTmp.searchCount,goodsInfo:drawInfoTmp.goodsInfo};else info=await fetchRecommGoodsInfo();gnbSearchInputElementDrawer.setRightArea(gnbSearchInputElementDrawer.getElement("basic__view__right"),info,setRightAreaEvent)}}finally{webV2Gnb.searchOpen();if(!searchInput){searchInput=document.querySelector("div.search__input__box input[type=text]");searchButton=document.querySelector("div.search__area button.search__find__btn");
searchInput.value="";searchInput.addEventListener("input",await inputEventLogic);searchButton.addEventListener("click",search);searchInput.addEventListener("keydown",function(event){if(event.key==="Enter")search()})}}}function search(){let keyword=searchInput.value.trim();if(typeof keyword!=="string")return;if(keyword!=="")searchHistoryManager.saveSearchHistory(keyword);if(!keyword)keyword=recommendKeyword;searchInput.value="";const info=gnbSearchRequestInfoManager.getRequestInfo("aisearch")(keyword);
const form=document.createElement("form");form.method=info.type;form.action=info.url;document.body.appendChild(form);form.submit()}return{init:()=>{searchAreaInner=document.querySelector("#header__navi .search__area__inner");contentBasicArea=document.querySelector("div.search__content__view.content__basic");contentResultArea=document.querySelector("div.search__content__view.content__result");searchHistoryManager.init();gnbSearchRequestInfoManager.init();gnbSearchInputRequestManager.init();gnbSearchInputElementDrawer.init();
let info=gnbSearchRequestInfoManager.getRequestInfo("recommendKeyword");fetch(info.url,{method:info.type}).then(response=>{return response.json()}).then(data=>{if(data.recommendKeyword)recommendKeyword=data.recommendKeyword})},openGnbSearchInputArea,search}})();
